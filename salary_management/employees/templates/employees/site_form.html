{% extends 'base.html' %}
{% load custom_filter %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h4>{{ form.instance.pk|yesno:"Edit Site,Add New Site" }}</h4>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="{{ form.site_code.id_for_label }}">Site Code *</label>
                                    {{ form.site_code|add_class:"form-control" }}
                                    {% if form.site_code.errors %}
                                        <div class="text-danger">{{ form.site_code.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="{{ form.site_name.id_for_label }}">Site Name *</label>
                                    {{ form.site_name|add_class:"form-control" }}
                                    {% if form.site_name.errors %}
                                        <div class="text-danger">{{ form.site_name.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="form-group mb-3">
                            <label for="{{ form.site_address_line1.id_for_label }}">Address Line 1</label>
                            {{ form.site_address_line1|add_class:"form-control" }}
                            {% if form.site_address_line1.errors %}
                                <div class="text-danger">{{ form.site_address_line1.errors }}</div>
                            {% endif %}
                        </div>

                        <div class="form-group mb-3">
                            <label for="{{ form.site_address_line2.id_for_label }}">Address Line 2</label>
                            {{ form.site_address_line2|add_class:"form-control" }}
                            {% if form.site_address_line2.errors %}
                                <div class="text-danger">{{ form.site_address_line2.errors }}</div>
                            {% endif %}
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="{{ form.site_city.id_for_label }}">City</label>
                                    {{ form.site_city|add_class:"form-control" }}
                                    {% if form.site_city.errors %}
                                        <div class="text-danger">{{ form.site_city.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="{{ form.site_state.id_for_label }}">State</label>
                                    {{ form.site_state|add_class:"form-control" }}
                                    {% if form.site_state.errors %}
                                        <div class="text-danger">{{ form.site_state.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="form-group mb-3">
                            <label for="{{ form.site_pincode.id_for_label }}">Pincode</label>
                            {{ form.site_pincode|add_class:"form-control" }}
                            {% if form.site_pincode.errors %}
                                <div class="text-danger">{{ form.site_pincode.errors }}</div>
                            {% endif %}
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="{{ form.site_contact_person_name.id_for_label }}">Contact Person</label>
                                    {{ form.site_contact_person_name|add_class:"form-control" }}
                                    {% if form.site_contact_person_name.errors %}
                                        <div class="text-danger">{{ form.site_contact_person_name.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="{{ form.site_contact_person_number.id_for_label }}">Contact Number</label>
                                    {{ form.site_contact_person_number|add_class:"form-control" }}
                                    {% if form.site_contact_person_number.errors %}
                                        <div class="text-danger">{{ form.site_contact_person_number.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="form-group mb-3">
                            <label for="{{ form.site_contact_person_email.id_for_label }}">Contact Email</label>
                            {{ form.site_contact_person_email|add_class:"form-control" }}
                            {% if form.site_contact_person_email.errors %}
                                <div class="text-danger">{{ form.site_contact_person_email.errors }}</div>
                            {% endif %}
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="{{ form.site_gst_number.id_for_label }}">GST Number</label>
                                    {{ form.site_gst_number|add_class:"form-control" }}
                                    {% if form.site_gst_number.errors %}
                                        <div class="text-danger">{{ form.site_gst_number.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="{{ form.site_salary_component_type.id_for_label }}">Salary Component Type</label>
                                    {{ form.site_salary_component_type|add_class:"form-control" }}
                                    {% if form.site_salary_component_type.errors %}
                                        <div class="text-danger">{{ form.site_salary_component_type.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="{{ form.site_pf_code.id_for_label }}">PF Code</label>
                                    {{ form.site_pf_code|add_class:"form-control" }}
                                    {% if form.site_pf_code.errors %}
                                        <div class="text-danger">{{ form.site_pf_code.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="{{ form.site_esic_code.id_for_label }}">ESIC Code</label>
                                    {{ form.site_esic_code|add_class:"form-control" }}
                                    {% if form.site_esic_code.errors %}
                                        <div class="text-danger">{{ form.site_esic_code.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="{{ form.site_account_number.id_for_label }}">Account Number</label>
                                    {{ form.site_account_number|add_class:"form-control" }}
                                    {% if form.site_account_number.errors %}
                                        <div class="text-danger">{{ form.site_account_number.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="{{ form.site_ifsc_code.id_for_label }}">IFSC Code</label>
                                    {{ form.site_ifsc_code|add_class:"form-control" }}
                                    {% if form.site_ifsc_code.errors %}
                                        <div class="text-danger">{{ form.site_ifsc_code.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Service Charges -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="{{ form.site_service_charge_salary.id_for_label }}">Service Charge (Salary)</label>
                                    {{ form.site_service_charge_salary|add_class:"form-control" }}
                                    {% if form.site_service_charge_salary.errors %}
                                        <div class="text-danger">{{ form.site_service_charge_salary.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="{{ form.site_service_charge_over_time.id_for_label }}">Service Charge (Overtime)</label>
                                    {{ form.site_service_charge_over_time|add_class:"form-control" }}
                                    {% if form.site_service_charge_over_time.errors %}
                                        <div class="text-danger">{{ form.site_service_charge_over_time.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Payroll Rules -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="{{ form.site_ot_rule.id_for_label }}">OT Rule</label>
                                    {{ form.site_ot_rule|add_class:"form-control" }}
                                    {% if form.site_ot_rule.errors %}
                                        <div class="text-danger">{{ form.site_ot_rule.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="{{ form.site_bonus_formula.id_for_label }}">Bonus Formula</label>
                                    {{ form.site_bonus_formula|add_class:"form-control" }}
                                    {% if form.site_bonus_formula.errors %}
                                        <div class="text-danger">{{ form.site_bonus_formula.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Deduction Rules -->
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group mb-3">
                                    <label for="{{ form.site_pf_deduction.id_for_label }}">PF Deduction</label>
                                    {{ form.site_pf_deduction|add_class:"form-control" }}
                                    {% if form.site_pf_deduction.errors %}
                                        <div class="text-danger">{{ form.site_pf_deduction.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group mb-3">
                                    <label for="{{ form.site_esic_deduction_rule.id_for_label }}">ESIC Deduction Rule</label>
                                    {{ form.site_esic_deduction_rule|add_class:"form-control" }}
                                    {% if form.site_esic_deduction_rule.errors %}
                                        <div class="text-danger">{{ form.site_esic_deduction_rule.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group mb-3">
                                    <label for="{{ form.site_welfare_deduction_rule.id_for_label }}">Welfare Deduction Rule</label>
                                    {{ form.site_welfare_deduction_rule|add_class:"form-control" }}
                                    {% if form.site_welfare_deduction_rule.errors %}
                                        <div class="text-danger">{{ form.site_welfare_deduction_rule.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        {% if salary_rule_formset %}
                        <h5 class="mt-4">Salary Rules</h5>
                        {{ salary_rule_formset.management_form }}
                        <div class="table-responsive mb-4">
                            <table class="table table-bordered table-hover text-center">
                                <thead class="thead-light">
                                    <tr>
                                        <th>Standard Head</th>
                                        <th>Rate Type</th>
                                        <th>Pay Type</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for formset_form in salary_rule_formset %}
                                    <tr>
                                        <td>Basic</td>
                                        <td>{{ formset_form.Basic_rate_type }}</td>
                                        <td>{{ formset_form.Basic_pay_type }}</td>
                                    </tr>
                                    <tr>
                                        <td>Sr All</td>
                                        <td>{{ formset_form.Sr_All_rate_type }}</td>
                                        <td>{{ formset_form.Sr_All_pay_type }}</td>
                                    </tr>
                                    <tr>
                                        <td>DA</td>
                                        <td>{{ formset_form.DA_rate_type }}</td>
                                        <td>{{ formset_form.DA_pay_type }}</td>
                                    </tr>
                                    <tr>
                                        <td>HRA</td>
                                        <td>{{ formset_form.HRA_rate_type }}</td>
                                        <td>{{ formset_form.HRA_pay_type }}</td>
                                    </tr>
                                    <tr>
                                        <td>TA</td>
                                        <td>{{ formset_form.TA_rate_type }}</td>
                                        <td>{{ formset_form.TA_pay_type }}</td>
                                    </tr>
                                    <tr>
                                        <td>Med</td>
                                        <td>{{ formset_form.Med_rate_type }}</td>
                                        <td>{{ formset_form.Med_pay_type }}</td>
                                    </tr>
                                    <tr>
                                        <td>Conv</td>
                                        <td>{{ formset_form.Conv_rate_type }}</td>
                                        <td>{{ formset_form.Conv_pay_type }}</td>
                                    </tr>
                                    <tr>
                                        <td>Wash</td>
                                        <td>{{ formset_form.Wash_rate_type }}</td>
                                        <td>{{ formset_form.Wash_pay_type }}</td>
                                    </tr>
                                    <tr>
                                        <td>Eff</td>
                                        <td>{{ formset_form.Eff_rate_type }}</td>
                                        <td>{{ formset_form.Eff_pay_type }}</td>
                                    </tr>
                                    <tr>
                                        <td>Other</td>
                                        <td>{{ formset_form.Other_rate_type }}</td>
                                        <td>{{ formset_form.Other_pay_type }}</td>
                                    </tr>
                                    <tr>
                                        <td>Incentive</td>
                                        <td>{{ formset_form.Incentive_rate_type }}</td>
                                        <td>{{ formset_form.Incentive_pay_type }}</td>
                                    </tr>
                                    <tr>
                                        <td>Bonus</td>
                                        <td>{{ formset_form.Bonus_rate_type }}</td>
                                        <td>{{ formset_form.Bonus_pay_type }}</td>
                                    </tr>
                                    <tr>
                                        <td>Over Time</td>
                                        <td>{{ formset_form.Over_Time_rate_type }}</td>
                                        <td>{{ formset_form.Over_Time_pay_type }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% endif %}

                        {% if salary_other_field_formset %}
                        <h5 class="mt-4">Salary Other Fields</h5>
                        {{ salary_other_field_formset.management_form }}
                        <div class="table-responsive mb-4">
                            <table class="table table-bordered table-hover text-center">
                                <thead class="thead-light">
                                    <tr>
                                        <th>Allowance Type</th>
                                        <th>Rate Type</th>
                                        <th>Pay Type</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for oform in salary_other_field_formset %}
                                    <tr>
                                        <td>Good Work Allowance</td>
                                        <td>{{ oform.Good_Work_Allowance_rate_type }}</td>
                                        <td>{{ oform.Good_Work_Allowance_pay_type }}</td>
                                    </tr>
                                    <tr>
                                        <td>ABRY</td>
                                        <td>{{ oform.ABRY_rate_type }}</td>
                                        <td>{{ oform.ABRY_pay_type }}</td>
                                    </tr>
                                    <tr>
                                        <td>Add Bonus</td>
                                        <td>{{ oform.Add_Bonus_rate_type }}</td>
                                        <td>{{ oform.Add_Bonus_pay_type }}</td>
                                    </tr>
                                    <tr>
                                        <td>Arrears</td>
                                        <td>{{ oform.Arrears_rate_type }}</td>
                                        <td>{{ oform.Arrears_pay_type }}</td>
                                    </tr>
                                    <tr>
                                        <td>Attendance Award</td>
                                        <td>{{ oform.Attnd_Award_rate_type }}</td>
                                        <td>{{ oform.Attnd_Award_pay_type }}</td>
                                    </tr>
                                    <tr>
                                        <td>Attendance Incentive</td>
                                        <td>{{ oform.Attnd_Incentive_rate_type }}</td>
                                        <td>{{ oform.Attnd_Incentive_pay_type }}</td>
                                    </tr>
                                    <tr>
                                        <td>Bonus Allowance</td>
                                        <td>{{ oform.Bonus_Allowance_rate_type }}</td>
                                        <td>{{ oform.Bonus_Allowance_pay_type }}</td>
                                    </tr>
                                    <tr>
                                        <td>Conveyance Allowance</td>
                                        <td>{{ oform.Conveyance_Allowance_rate_type }}</td>
                                        <td>{{ oform.Conveyance_Allowance_pay_type }}</td>
                                    </tr>
                                    <tr>
                                        <td>Festival Bonus Refund</td>
                                        <td>{{ oform.Festival_Bonus_refund_rate_type }}</td>
                                        <td>{{ oform.Festival_Bonus_refund_pay_type }}</td>
                                    </tr>
                                    <tr>
                                        <td>Gratuity</td>
                                        <td>{{ oform.Gratuity_rate_type }}</td>
                                        <td>{{ oform.Gratuity_pay_type }}</td>
                                    </tr>
                                    <tr>
                                        <td>Night Allowance</td>
                                        <td>{{ oform.Night_Allowance_rate_type }}</td>
                                        <td>{{ oform.Night_Allowance_pay_type }}</td>
                                    </tr>
                                    <tr>
                                        <td>Production Incentive</td>
                                        <td>{{ oform.Production_incentive_rate_type }}</td>
                                        <td>{{ oform.Production_incentive_pay_type }}</td>
                                    </tr>
                                    <tr>
                                        <td>Welding Allowance</td>
                                        <td>{{ oform.Welding_Allowance_rate_type }}</td>
                                        <td>{{ oform.Welding_Allowance_pay_type }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% endif %}

                        <div class="form-group">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save"></i> Save Site
                            </button>
                            <a href="{% url 'employees:site_list' %}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %} 