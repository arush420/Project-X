{% extends 'base.html' %}
{% load static %}

{% block title %}Service Bill #{{ bill.bill_number }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Action Buttons -->
            <div class="mb-3 d-print-none">
                <a href="{% url 'employees:service_bill_list' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Bills
                </a>
                <a href="{% url 'employees:service_bill_update' bill.pk %}" class="btn btn-primary">
                    <i class="fas fa-edit"></i> Edit Bill
                </a>
                <a href="{% url 'employees:service_bill_print' bill.pk %}" class="btn btn-info" target="_blank">
                    <i class="fas fa-print"></i> Print
                </a>
                <button onclick="window.print()" class="btn btn-success">
                    <i class="fas fa-file-pdf"></i> Print/PDF
                </button>
            </div>

            <!-- Bill Content -->
            <div class="bill-container bg-white p-4 border">
                <!-- Bill Header -->
                <div class="row mb-4">
                    <div class="col-8">
                        <h2 class="fw-bold text-uppercase">{{ bill.company.company_name }}</h2>
                        <div class="company-details">
                            <p class="mb-1">{{ bill.company.company_address }}</p>
                            <p class="mb-1">Contact: {{ bill.company.company_contact_person_name }}</p>
                            <p class="mb-1">Phone: {{ bill.company.company_contact_person_number }}</p>
                            <p class="mb-1">Email: {{ bill.company.company_contact_person_email }}</p>
                            <p class="mb-1">GST No: {{ bill.company.company_gst_number }}</p>
                        </div>
                    </div>
                    <div class="col-4 text-end">
                        <table style="width:100%; border:2px solid #222; border-collapse:collapse;">
                            <tr>
                                <th style="border:1px solid #222; padding:4px;">Bill No</th>
                                <th style="border:1px solid #222; padding:4px;">Dated</th>
                            </tr>
                            <tr>
                                <td style="border:1px solid #222; font-weight:bold; font-size:1.1em; padding:4px;">{{ bill.bill_number }}</td>
                                <td style="border:1px solid #222; font-weight:bold; font-size:1.1em; padding:4px;">{{ bill.bill_date|date:"d-M-Y" }}</td>
                            </tr>
                        </table>
                    </div>
                </div>

                <!-- Bill To Section -->
                <div class="row mb-4">
                    <div class="col-6">
                        <div class="border p-3">
                            <h5 class="fw-bold mb-2">Bill to</h5>
                            <p class="fw-bold mb-1">{{ bill.client_name }}</p>
                            <p class="mb-1">{{ bill.client_address }}</p>
                            {% if bill.client_gst_number %}
                            <p class="mb-1">GST No: {{ bill.client_gst_number }}</p>
                            {% endif %}
                            {% if bill.client_contact_person %}
                            <p class="mb-1">Contact: {{ bill.client_contact_person }}</p>
                            {% endif %}
                            {% if bill.client_phone %}
                            <p class="mb-1">Phone: {{ bill.client_phone }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Description of Service Table -->
                <div class="mb-4">
                    <table class="table table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 60%;">Description of Services</th>
                                <th style="width: 20%;">HSN CODE</th>
                                <th style="width: 20%;">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in line_items %}
                            <tr>
                                <td>{{ item.description }}</td>
                                <td class="text-center">{{ item.hsn_code }}</td>
                                <td class="text-end">₹{{ item.amount|floatformat:2 }}</td>
                            </tr>
                            {% endfor %}
                            <!-- Totals Section -->
                            <tr>
                                <td colspan="2" class="text-end fw-bold">TOTAL GROSS WAGES</td>
                                <td class="text-end fw-bold">₹{{ bill.total_gross_wages|floatformat:2 }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Calculation Section -->
                <div class="row mb-4">
                    <div class="col-12">
                        <table class="table table-bordered" style="border:2px solid #222;">
                            <tbody>
                                <!-- Section: TOTAL GROSS WAGES -->
                                <tr>
                                    <td colspan="2" class="fw-bold" style="background:#f5f5f5;">TOTAL GROSS WAGES</td>
                                    <td class="text-end fw-bold">₹{{ bill.total_gross_wages|floatformat:2 }}</td>
                                </tr>
                                {% if bill.template.apply_esi %}
                                <tr>
                                    <td>ESI CONTRIBUTION @{{ bill.template.esi_rate }}%</td>
                                    <td class="text-end">₹{{ bill.total_gross_wages|floatformat:2 }}</td>
                                    <td class="text-end">₹{{ bill.total_esi_contribution|floatformat:2 }}</td>
                                </tr>
                                {% endif %}
                                {% if bill.template.apply_service_charge %}
                                <tr>
                                    <td>SERVICE CHARGE @ {{ bill.template.service_charge_rate }}%</td>
                                    <td class="text-end">₹{{ bill.total_gross_wages|floatformat:2 }}</td>
                                    <td class="text-end">₹{{ bill.total_service_charge|floatformat:2 }}</td>
                                </tr>
                                {% endif %}
                                <!-- Section: Taxable Value -->
                                <tr>
                                    <td colspan="2" class="fw-bold" style="background:#f5f5f5;">Taxable Value</td>
                                    <td class="text-end fw-bold">₹{{ bill.taxable_value|floatformat:2 }}</td>
                                </tr>
                                {% if bill.template.apply_cgst_sgst %}
                                <tr>
                                    <td>CGST @ {{ bill.template.cgst_rate }}%</td>
                                    <td></td>
                                    <td class="text-end">₹{{ bill.cgst_amount|floatformat:2 }}</td>
                                </tr>
                                <tr>
                                    <td>SGST @ {{ bill.template.sgst_rate }}%</td>
                                    <td></td>
                                    <td class="text-end">₹{{ bill.sgst_amount|floatformat:2 }}</td>
                                </tr>
                                {% elif bill.template.apply_igst %}
                                <tr>
                                    <td>IGST @ {{ bill.template.igst_rate }}%</td>
                                    <td></td>
                                    <td class="text-end">₹{{ bill.igst_amount|floatformat:2 }}</td>
                                </tr>
                                {% endif %}
                                {% if bill.template.round_to_nearest and bill.template.round_to_nearest > 0 %}
                                <tr>
                                    <td>ROUND</td>
                                    <td></td>
                                    <td class="text-end">₹{{ bill.rounding_difference|floatformat:2 }}</td>
                                </tr>
                                {% endif %}
                                <tr style="background:#e5e5e5;">
                                    <td colspan="2" class="fw-bold text-end">TOTAL</td>
                                    <td class="text-end fw-bold">₹{{ bill.total_amount|floatformat:2 }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- Amount in Words -->
                <div class="mb-4">
                    <strong>Amount (in word):</strong> {{ bill.get_amount_in_words }}
                </div>

                <!-- Footer -->
                <div class="row mt-5">
                    <div class="col-8">
                        {% if bill.payment_terms %}
                        <p><strong>Payment Terms:</strong> {{ bill.payment_terms }}</p>
                        {% endif %}
                        {% if bill.notes %}
                        <p><strong>Notes:</strong> {{ bill.notes }}</p>
                        {% endif %}
                    </div>
                    <div class="col-4 text-end">
                        <div class="mt-5 pt-3">
                            <p class="mb-0">For {{ bill.company.company_name }}</p>
                            <div style="height: 60px;"></div>
                            <p class="mt-3 mb-0 border-top pt-2">Authorized Signatory</p>
                        </div>
                    </div>
                </div>

                <!-- Bill Status -->
                <div class="row mt-3 d-print-none">
                    <div class="col-12">
                        <span class="badge 
                            {% if bill.status == 'draft' %}bg-secondary
                            {% elif bill.status == 'sent' %}bg-primary
                            {% elif bill.status == 'paid' %}bg-success
                            {% elif bill.status == 'overdue' %}bg-danger
                            {% else %}bg-warning{% endif %}">
                            {{ bill.get_status_display }}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
@media print {
    .d-print-none {
        display: none !important;
    }
    
    .bill-container {
        box-shadow: none !important;
        border: none !important;
    }
    
    body {
        font-size: 12px;
    }
    
    table {
        font-size: 11px;
    }
}

.bill-container {
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
}

.company-details p {
    font-size: 0.9rem;
}

.bill-info {
    background-color: #f8f9fa;
}
</style>
{% endblock %} 