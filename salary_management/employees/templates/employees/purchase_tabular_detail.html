{% extends 'base.html' %}
{% load static %}
{% load custom_filter %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-file-invoice me-2"></i>{{ title }}
                    </h4>
                    <a href="{% url 'employees:purchase_tabular_list' %}" class="btn btn-light">
                        <i class="fas fa-arrow-left me-2"></i>Back to List
                    </a>
                </div>
                <div class="card-body">
                    <!-- Purchase Header Information -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Purchase Information</h6>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm">
                                        <tr>
                                            <th width="40%">Bill Number:</th>
                                            <td><strong>{{ purchase.bill_number }}</strong></td>
                                        </tr>
                                        <tr>
                                            <th>Purchase Date:</th>
                                            <td>{{ purchase.date_of_purchase|date:"d M Y" }}</td>
                                        </tr>
                                        <tr>
                                            <th>PO Number:</th>
                                            <td>{{ purchase.po_number|default:"N/A" }}</td>
                                        </tr>
                                        <tr>
                                            <th>Order By:</th>
                                            <td>{{ purchase.order_by|default:"N/A" }}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Vendor Information</h6>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm">
                                        <tr>
                                            <th width="40%">Vendor ID:</th>
                                            <td>{{ purchase.organization_code }}</td>
                                        </tr>
                                        <tr>
                                            <th>Vendor Name:</th>
                                            <td><strong>{{ purchase.organization_name }}</strong></td>
                                        </tr>
                                        <tr>
                                            <th>GST Number:</th>
                                            <td>{{ purchase.organization_gst_number|default:"N/A" }}</td>
                                        </tr>
                                        <tr>
                                            <th>Payment Status:</th>
                                            <td>
                                                {% if purchase.payment_status == 'full_payment_vendor' %}
                                                    <span class="badge bg-success">Paid</span>
                                                {% elif purchase.payment_status == 'part_payment_vendor' %}
                                                    <span class="badge bg-warning">Partial</span>
                                                {% else %}
                                                    <span class="badge bg-danger">Pending</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Items Table -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">Items Purchased</h6>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Item Name</th>
                                            <th>HSN Code</th>
                                            <th>Unit Cost (₹)</th>
                                            <th>Quantity</th>
                                            <th>Gross Total (₹)</th>
                                            <th>CGST Rate (%)</th>
                                            <th>CGST Amount (₹)</th>
                                            <th>SGST Rate (%)</th>
                                            <th>SGST Amount (₹)</th>
                                            <th>IGST Rate (%)</th>
                                            <th>IGST Amount (₹)</th>
                                            <th>Total (₹)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in line_items %}
                                            <tr>
                                                <td><strong>{{ item.purchased_item }}</strong></td>
                                                <td>{{ item.hsn_code }}</td>
                                                <td>₹{{ item.per_unit_cost|floatformat:2 }}</td>
                                                <td>{{ item.units_bought }}</td>
                                                <td>₹{{ item.total_amount|floatformat:2 }}</td>
                                                <td>{{ item.cgst_rate|default:"0.00" }}%</td>
                                                <td>₹{{ item.cgst_amount|floatformat:2 }}</td>
                                                <td>{{ item.sgst_rate|default:"0.00" }}%</td>
                                                <td>₹{{ item.sgst_amount|floatformat:2 }}</td>
                                                <td>{{ item.igst_rate|default:"0.00" }}%</td>
                                                <td>₹{{ item.igst_amount|floatformat:2 }}</td>
                                                <td><strong>₹{{ item.total_with_gst|floatformat:2 }}</strong></td>
                                            </tr>
                                        {% empty %}
                                            <tr>
                                                <td colspan="12" class="text-center text-muted">No items found</td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Totals Section -->
                    <div class="row">
                        <div class="col-md-8">
                            {% if purchase.payment_status != 'unpaid_vendor' %}
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">Payment Details</h6>
                                    </div>
                                    <div class="card-body">
                                        <table class="table table-sm">
                                            {% if purchase.payment_status == 'part_payment_vendor' %}
                                                <tr>
                                                    <th width="40%">Amount Paid:</th>
                                                    <td><strong>₹{{ purchase.amount_paid|floatformat:2 }}</strong></td>
                                                </tr>
                                                <tr>
                                                    <th>Balance Amount:</th>
                                                    <td class="{% if purchase.balance_amount > 0 %}text-danger{% else %}text-success{% endif %}">
                                                        <strong>₹{{ purchase.balance_amount|floatformat:2 }}</strong>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <th>Payment Progress:</th>
                                                    <td>
                                                        <div class="progress mb-2">
                                                            <div class="progress-bar" role="progressbar" style="width: {{ purchase.payment_percentage }}%">
                                                                {{ purchase.payment_percentage|floatformat:1 }}%
                                                            </div>
                                                        </div>
                                                    </td>
                                                </tr>
                                            {% endif %}
                                            <tr>
                                                <th>Payment By:</th>
                                                <td>{{ purchase.payment_by|default:"N/A" }}</td>
                                            </tr>
                                            <tr>
                                                <th>Payment Date:</th>
                                                <td>{{ purchase.payment_date|date:"d M Y"|default:"N/A" }}</td>
                                            </tr>
                                            <tr>
                                                <th>Payment Mode:</th>
                                                <td>{{ purchase.get_payment_mode_display|default:"N/A" }}</td>
                                            </tr>
                                        </table>
                                        
                                        {% if purchase.payment_status == 'part_payment_vendor' and purchase.balance_amount > 0 %}
                                            <div class="alert alert-warning mt-3">
                                                <i class="fas fa-exclamation-triangle me-2"></i>
                                                <strong>Partial Payment:</strong> ₹{{ purchase.balance_amount|floatformat:2 }} remaining to be paid.
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% else %}
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">Payment Status</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="alert alert-danger">
                                            <i class="fas fa-exclamation-circle me-2"></i>
                                            <strong>Payment Pending:</strong> No payment has been made yet.
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Amount Summary</h6>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm">
                                        <tr>
                                            <th>Subtotal:</th>
                                            <td class="text-end">₹{{ purchase.total_gross_amount|floatformat:2 }}</td>
                                        </tr>
                                        <tr>
                                            <th>Total CGST:</th>
                                            <td class="text-end">₹{{ line_items|total_cgst_amount|floatformat:2 }}</td>
                                        </tr>
                                        <tr>
                                            <th>Total SGST:</th>
                                            <td class="text-end">₹{{ line_items|total_sgst_amount|floatformat:2 }}</td>
                                        </tr>
                                        <tr>
                                            <th>Total IGST:</th>
                                            <td class="text-end">₹{{ line_items|total_igst_amount|floatformat:2 }}</td>
                                        </tr>
                                        <tr>
                                            <th>Total GST:</th>
                                            <td class="text-end">₹{{ purchase.total_gst_amount|floatformat:2 }}</td>
                                        </tr>
                                        <tr class="table-dark">
                                            <th><strong>Grand Total:</strong></th>
                                            <td class="text-end"><strong>₹{{ purchase.total_net_amount|floatformat:2 }}</strong></td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Information -->
                    {% if purchase.remark %}
                        <div class="card mt-4">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">Remarks</h6>
                            </div>
                            <div class="card-body">
                                <p class="mb-0">{{ purchase.remark }}</p>
                            </div>
                        </div>
                    {% endif %}

                    {% if purchase.bill_file %}
                        <div class="card mt-4">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">Attached Files</h6>
                            </div>
                            <div class="card-body">
                                <a href="{{ purchase.bill_file.url }}" target="_blank" class="btn btn-outline-primary">
                                    <i class="fas fa-download me-2"></i>Download Bill
                                </a>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %} 