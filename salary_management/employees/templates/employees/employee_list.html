{% extends 'base.html' %}

{% block title %}Employee List{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1 class="mb-4">Employee List</h1>

    <!-- Filter and Sort form -->
    <form method="get" class="form-inline mb-3">
        <div class="form-group mr-3">
            <label for="search" class="mr-2">Search:</label>
            <input type="text" id="search" name="search" class="form-control" value="{{ search_query }}" placeholder="Employee code or name">
        </div>

        <div class="form-group mr-3">
            <label for="department" class="mr-2">Department:</label>
            <select id="department" name="department" class="form-control">
                <option value="">All</option>
                {% for dept in departments %}
                    <option value="{{ dept.id }}" {% if dept.id == department %}selected{% endif %}>{{ dept.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group mr-3">
            <label for="salary_range" class="mr-2">Salary Range:</label>
            <select id="salary_range" name="salary_range" class="form-control">
                <option value="">All</option>
                <option value="1" {% if salary_range == '1' %}selected{% endif %}>Below 20,000</option>
                <option value="2" {% if salary_range == '2' %}selected{% endif %}>20,000 - 50,000</option>
                <option value="3" {% if salary_range == '3' %}selected{% endif %}>Above 50,000</option>
            </select>
        </div>

        <div class="form-group mr-3">
            <label for="sort" class="mr-2">Sort By:</label>
            <select id="sort" name="sort" class="form-control">
                <option value="">Default</option>
                <option value="name_asc" {% if sort == 'name_asc' %}selected{% endif %}>Name (A-Z)</option>
                <option value="name_desc" {% if sort == 'name_desc' %}selected{% endif %}>Name (Z-A)</option>
                <option value="salary_asc" {% if sort == 'salary_asc' %}selected{% endif %}>Salary (Low to High)</option>
                <option value="salary_desc" {% if sort == 'salary_desc' %}selected{% endif %}>Salary (High to Low)</option>
            </select>
        </div>

        <button type="submit" class="btn btn-primary">Apply Filters</button>
    </form>

    <!-- Employee table -->
    <div class="table-responsive">
        <form id="delete-multiple-form" method="POST" action="{% url 'employees:delete_multiple_employees' %}">
            {% csrf_token %}
            <table class="table table-bordered table-striped">
                <thead class="thead-dark">
                    <tr>
                        {% if user.is_superuser %}
                            <th style="display: none;" id="select-header">Select</th>
                        {% endif %}
                        <th>Employee Code</th>
                        <th>Name</th>
                        <th>Father Name</th>
                        <th>UAN</th>
                        <th>ESIC</th>
                        <th>Account Number</th>
                        <th>IFSC</th>
                        <th>Last Salary</th>
                        <th>Last Net Pay</th>
                        <th>Flag</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if employees %}
                        {% for employee in employees %}
                        <tr>
                            {% if user.is_superuser %}
                                <td style="display: none;">
                                    <input form="delete-multiple-form" type="checkbox" name="employee_ids" value="{{ employee.id }}">
                                </td>
                            {% endif %}
                            <td><a href="{% url 'employees:employee_details' employee.id %}">{{ employee.employee_code }}</a></td>
                            <td>{{ employee.name }}</td>
                            <td>{{ employee.father_name }}</td>
                            <td>{{ employee.uan }}</td>
                            <td>{{ employee.esic_no }}</td>
                            <td>{{ employee.employee_account }}</td>
                            <td>{{ employee.ifsc }}</td>
                            <td>{{ employee.pf }}</td>
                            <td>{{ employee.advance }}</td>
                            <td>
                                <span class="performance-box" style="background-color: {{ employee.get_performance_color_display|lower }};"></span>
                            </td>
                            <td>
                                <span class="action-icon" onclick="toggleActionMenu('{{ employee.pk }}')">✏️</span>
                                <div class="action-menu" id="action-menu-{{ employee.pk }}" style="display: none;">
                                    <a href="{% url 'employees:edit_employee' employee.pk %}" class="dropdown-item">Edit</a>
                                    <a href="{% url 'employees:delete_employee' employee.pk %}" class="dropdown-item" onclick="return confirm('Are you sure you want to delete this employee?');">Delete</a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="12" class="text-center">No employees found matching your search criteria.</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </form>
    </div>

    <!-- Pagination and other elements remain the same -->

</div>

<script>
    function toggleActionMenu(employeeId) {
        const menu = document.getElementById(`action-menu-${employeeId}`);
        menu.style.display = menu.style.display === "none" || !menu.style.display ? "block" : "none";
    }

    document.addEventListener('click', function(event) {
        if (!event.target.closest('.action-icon')) {
            document.querySelectorAll('.action-menu').forEach(menu => {
                menu.style.display = 'none';
            });
        }
    });
</script>

<style>
    .performance-box {
        display: inline-block;
        width: 15px;
        height: 15px;
        border-radius: 50%;
        vertical-align: middle;
    }
    .action-icon {
        cursor: pointer;
        font-size: 1.5em;
    }
    .action-menu {
        position: absolute;
        background-color: white;
        border: 1px solid #ccc;
        padding: 5px;
        box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
        z-index: 10;
        border-radius: 4px;
    }
    .dropdown-item {
        display: block;
        padding: 5px 10px;
        color: #333;
        text-decoration: none;
    }
    .dropdown-item:hover {
        background-color: #f8f9fa;
    }
</style>

{% endblock %}
