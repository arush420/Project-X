{% extends 'base.html' %}

{% block title %}Employee List{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1 class="mb-4">Employee List</h1>

    <!-- Filter and Sort form -->
    <form method="get" class="mb-4">
        <div class="row">
            <div class="col-md-3">
                <input type="text" name="search" class="form-control" placeholder="Employee code or name" value="{{ search_query }}">
            </div>
            <div class="col-md-3">
                <select name="site" class="form-control">
                    <option value="">All Sites</option>
                    {% for site in sites %}
                        <option value="{{ site.id }}" {% if selected_site_id == site.id|stringformat:"s" %}selected{% endif %}>
                            {{ site.site_name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary">Apply Filters</button>
            </div>
        </div>
    </form>

    <!-- Employee table -->
    <div class="table-responsive">
        <form id="delete-multiple-form" method="POST" action="{% url 'employees:delete_multiple_employees' %}">
            {% csrf_token %}
            <table class="table table-bordered table-striped">
                <thead class="thead-dark">
                    <tr>
                        {% if user.is_superuser %}
                            <th style="display: none;" id="select-header">Select</th>
                        {% endif %}
                        <th>Employee Code</th>
                        <th>Name</th>
                        <th>Father Name</th>
                        <th>UAN</th>
                        <th>ESIC</th>
                        <th>Account Number</th>
                        <th>IFSC</th>
                        <th>Last Salary</th>
                        <th>Last Net Pay</th>
                        <th>Flag</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if employees %}
                        {% for employee in employees %}
                        <tr>
                            {% if user.is_superuser %}
                                <td style="display: none;">
                                    <input form="delete-multiple-form" type="checkbox" name="employee_ids" value="{{ employee.id }}">
                                </td>
                            {% endif %}
                            <td><a href="{% url 'employees:employee_details' employee.id %}">{{ employee.employee_code }}</a></td>
                            <td>{{ employee.name }}</td>
                            <td>{{ employee.father_name }}</td>
                            <td>{{ employee.uan }}</td>
                            <td>{{ employee.esic_no }}</td>
                            <td>{{ employee.employee_account }}</td>
                            <td>{{ employee.ifsc }}</td>
                            <td>{{ employee.pf }}</td>
                            <td>{{ employee.advance }}</td>
                            <td>
                                <span class="performance-box" style="background-color: {{ employee.get_performance_color_display|lower }};"></span>
                            </td>
                            <td>
                                <span class="action-icon" onclick="toggleActionMenu('{{ employee.pk }}')">✏️</span>
                                <div class="action-menu" id="action-menu-{{ employee.pk }}" style="display: none;">
                                    <a href="{% url 'employees:edit_employee' employee.pk %}" class="dropdown-item">Edit</a>
                                    <a href="{% url 'employees:delete_employee' employee.pk %}" class="dropdown-item" onclick="return confirm('Are you sure you want to delete this employee?');">Delete</a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="12" class="text-center">No employees found matching your search criteria.</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </form>
    </div>

    <!-- Pagination and other elements remain the same -->

</div>

<script>
    function toggleActionMenu(employeeId) {
        const menu = document.getElementById(`action-menu-${employeeId}`);
        menu.style.display = menu.style.display === "none" || !menu.style.display ? "block" : "none";
    }

    document.addEventListener('click', function(event) {
        if (!event.target.closest('.action-icon')) {
            document.querySelectorAll('.action-menu').forEach(menu => {
                menu.style.display = 'none';
            });
        }
    });
</script>

<style>
    .performance-box {
        display: inline-block;
        width: 15px;
        height: 15px;
        border-radius: 50%;
        vertical-align: middle;
    }
    .action-icon {
        cursor: pointer;
        font-size: 1.5em;
    }
    .action-menu {
        position: absolute;
        background-color: white;
        border: 1px solid #ccc;
        padding: 5px;
        box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
        z-index: 10;
        border-radius: 4px;
    }
    .dropdown-item {
        display: block;
        padding: 5px 10px;
        color: #333;
        text-decoration: none;
    }
    .dropdown-item:hover {
        background-color: #f8f9fa;
    }
</style>

{% endblock %}
