{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-shopping-cart me-2"></i>{{ title }}
                    </h4>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" id="purchase-form">
                        {% csrf_token %}
                        
                        <!-- GST rates are now handled by the Purchase form fields -->
                        
                        <!-- Organization Details Section -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">
                                    <i class="fas fa-building me-2"></i>Organization Details
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="form-group mb-3">
                                            <label class="form-label font-weight-bold">Order For (Vendor)</label>
                                            {{ purchase_form.order_for }}
                                            {% if purchase_form.order_for.errors %}
                                                <div class="text-danger small">{{ purchase_form.order_for.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group mb-3">
                                            <label class="form-label font-weight-bold">Vendor ID</label>
                                            {{ purchase_form.organization_code }}
                                            {% if purchase_form.organization_code.errors %}
                                                <div class="text-danger small">{{ purchase_form.organization_code.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group mb-3">
                                            <label class="form-label font-weight-bold">Vendor Name</label>
                                            {{ purchase_form.organization_name }}
                                            {% if purchase_form.organization_name.errors %}
                                                <div class="text-danger small">{{ purchase_form.organization_name.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group mb-3">
                                            <label class="form-label font-weight-bold">Vendor GST Number</label>
                                            {{ purchase_form.organization_gst_number }}
                                            {% if purchase_form.organization_gst_number.errors %}
                                                <div class="text-danger small">{{ purchase_form.organization_gst_number.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Bill & Order Details Section -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">
                                    <i class="fas fa-file-invoice me-2"></i>Bill & Order Details
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="form-group mb-3">
                                            <label class="form-label font-weight-bold">Bill Number</label>
                                            {{ purchase_form.bill_number }}
                                            {% if purchase_form.bill_number.errors %}
                                                <div class="text-danger small">{{ purchase_form.bill_number.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group mb-3">
                                            <label class="form-label font-weight-bold">PO Number</label>
                                            {{ purchase_form.po_number }}
                                            {% if purchase_form.po_number.errors %}
                                                <div class="text-danger small">{{ purchase_form.po_number.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group mb-3">
                                            <label class="form-label font-weight-bold">Order By</label>
                                            {{ purchase_form.order_by }}
                                            {% if purchase_form.order_by.errors %}
                                                <div class="text-danger small">{{ purchase_form.order_by.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group mb-3">
                                            <label class="form-label font-weight-bold">Purchase Date</label>
                                            {{ purchase_form.date_of_purchase }}
                                            {% if purchase_form.date_of_purchase.errors %}
                                                <div class="text-danger small">{{ purchase_form.date_of_purchase.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>

                        <!-- Item Details Section -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">
                                    <i class="fas fa-boxes me-2"></i>Item Details
                                </h5>
                            </div>
                            <div class="card-body">
                                {{ formset.management_form }}
                                
                                <div class="table-responsive">
                                    <table class="table table-bordered table-striped" id="items-table">
                                        <thead class="table-dark">
                                            <tr>
                                                <th width="12%">Item Name</th>
                                                <th width="8%">HSN Code</th>
                                                <th width="8%">Unit Cost (₹)</th>
                                                <th width="6%">Quantity</th>
                                                <th width="8%">Gross Total (₹)</th>
                                                <th width="8%">CGST Rate (%)</th>
                                                <th width="8%">CGST Amount (₹)</th>
                                                <th width="8%">SGST Rate (%)</th>
                                                <th width="8%">SGST Amount (₹)</th>
                                                <th width="8%">IGST Rate (%)</th>
                                                <th width="8%">IGST Amount (₹)</th>
                                                <th width="8%">Total (₹)</th>
                                                <th width="4%">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="items-tbody">
                                            {% for form in formset %}
                                                <tr class="item-row">
                                                    <td>
                                                        {{ form.purchased_item }}
                                                        {% if form.purchased_item.errors %}
                                                            <div class="text-danger small">{{ form.purchased_item.errors }}</div>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        {{ form.hsn_code }}
                                                        {% if form.hsn_code.errors %}
                                                            <div class="text-danger small">{{ form.hsn_code.errors }}</div>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        {{ form.per_unit_cost }}
                                                        {% if form.per_unit_cost.errors %}
                                                            <div class="text-danger small">{{ form.per_unit_cost.errors }}</div>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        {{ form.units_bought }}
                                                        {% if form.units_bought.errors %}
                                                            <div class="text-danger small">{{ form.units_bought.errors }}</div>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        <span class="gross-total">0.00</span>
                                                    </td>
                                                    <td>
                                                        {{ form.cgst_rate }}
                                                        {% if form.cgst_rate.errors %}
                                                            <div class="text-danger small">{{ form.cgst_rate.errors }}</div>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        <span class="cgst-amount">0.00</span>
                                                    </td>
                                                    <td>
                                                        {{ form.sgst_rate }}
                                                        {% if form.sgst_rate.errors %}
                                                            <div class="text-danger small">{{ form.sgst_rate.errors }}</div>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        <span class="sgst-amount">0.00</span>
                                                    </td>
                                                    <td>
                                                        {{ form.igst_rate }}
                                                        {% if form.igst_rate.errors %}
                                                            <div class="text-danger small">{{ form.igst_rate.errors }}</div>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        <span class="igst-amount">0.00</span>
                                                    </td>
                                                    <td>
                                                        <span class="total-amount">0.00</span>
                                                    </td>
                                                    <td>
                                                        <button type="button" class="btn btn-sm btn-danger remove-item">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                
                                <div class="row mt-3">
                                    <div class="col-md-6">
                                        <button type="button" class="btn btn-success" id="add-item">
                                            <i class="fas fa-plus me-2"></i>Add Item
                                        </button>
                                    </div>
                                    <div class="col-md-6 text-end">
                                        <div class="card bg-light">
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-6"><strong>Grand Total:</strong></div>
                                                    <div class="col-6 text-end">₹<span id="grand-total">0.00</span></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>



                        <!-- Payment Details Section -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">
                                    <i class="fas fa-credit-card me-2"></i>Payment Details
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="form-group mb-3">
                                            <label class="form-label font-weight-bold">Payment Status</label>
                                            {{ purchase_form.payment_status }}
                                            {% if purchase_form.payment_status.errors %}
                                                <div class="text-danger small">{{ purchase_form.payment_status.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-3 payment-field" data-field="payment_by">
                                        <div class="form-group mb-3">
                                            <label class="form-label font-weight-bold">Payment By</label>
                                            {{ purchase_form.payment_by }}
                                            {% if purchase_form.payment_by.errors %}
                                                <div class="text-danger small">{{ purchase_form.payment_by.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-3 payment-field" data-field="payment_date">
                                        <div class="form-group mb-3">
                                            <label class="form-label font-weight-bold">Payment Date</label>
                                            {{ purchase_form.payment_date }}
                                            {% if purchase_form.payment_date.errors %}
                                                <div class="text-danger small">{{ purchase_form.payment_date.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-3 payment-field" data-field="payment_mode">
                                        <div class="form-group mb-3">
                                            <label class="form-label font-weight-bold">Payment Mode</label>
                                            {{ purchase_form.payment_mode }}
                                            {% if purchase_form.payment_mode.errors %}
                                                <div class="text-danger small">{{ purchase_form.payment_mode.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Partial Payment Amount Field (shown only when part payment is selected) -->
                                <div class="row" id="partial-payment-row" style="display: none;">
                                    <div class="col-md-4">
                                        <div class="form-group mb-3">
                                            <label class="form-label font-weight-bold">Amount Paid (₹)</label>
                                            {{ purchase_form.amount_paid }}
                                            {% if purchase_form.amount_paid.errors %}
                                                <div class="text-danger small">{{ purchase_form.amount_paid.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group mb-3">
                                            <label class="form-label font-weight-bold">Total Amount (₹)</label>
                                            <div class="form-control bg-light" id="total-amount-display">0.00</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group mb-3">
                                            <label class="form-label font-weight-bold">Balance Amount (₹)</label>
                                            <div class="form-control bg-light text-danger" id="balance-amount-display">0.00</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Additional Details Section -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">
                                    <i class="fas fa-info-circle me-2"></i>Additional Details
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label class="form-label font-weight-bold">Remarks</label>
                                            {{ purchase_form.remark }}
                                            {% if purchase_form.remark.errors %}
                                                <div class="text-danger small">{{ purchase_form.remark.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label class="form-label font-weight-bold">Bill File</label>
                                            {{ purchase_form.bill_file }}
                                            {% if purchase_form.bill_file.errors %}
                                                <div class="text-danger small">{{ purchase_form.bill_file.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="text-center">
                            <button type="submit" class="btn btn-primary btn-lg me-3">
                                <i class="fas fa-save me-2"></i>Create Purchase Order
                            </button>
                            <a href="{% url 'employees:purchase_tabular_list' %}" class="btn btn-secondary btn-lg">
                                <i class="fas fa-arrow-left me-2"></i>Back to List
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let formIndex = {{ formset.total_form_count }};
    const maxForms = {{ formset.max_num|default:1000 }};
    
    // Vendor auto-fill functionality
    const vendorSelect = document.querySelector('select[name="order_for"]');
    if (vendorSelect) {
        vendorSelect.addEventListener('change', function() {
            const vendorId = this.value;
            if (vendorId) {
                fetch(`/employees/api/vendor/${vendorId}/`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            console.error('Error:', data.error);
                        } else {
                            // Fill vendor details
                            document.querySelector('input[name="organization_code"]').value = data.vendor_id || '';
                            document.querySelector('input[name="organization_name"]').value = data.vendor_name || '';
                            document.querySelector('input[name="organization_gst_number"]').value = data.vendor_gst_number || '';
                        }
                    })
                    .catch(error => console.error('Error:', error));
            }
        });
    }
    
    // Payment status change handler
    const paymentStatusSelect = document.querySelector('select[name="payment_status"]');
    if (paymentStatusSelect) {
        paymentStatusSelect.addEventListener('change', function() {
            togglePaymentFields(this);
        });
        
        // Initialize on page load
        togglePaymentFields(paymentStatusSelect);
    }
    
    function togglePaymentFields(paymentStatusSelect) {
        const paymentFields = document.querySelectorAll('.payment-field');
        const isPending = paymentStatusSelect.value === 'unpaid_vendor';
        
        paymentFields.forEach(field => {
            if (isPending) {
                field.style.display = 'none';
            } else {
                field.style.display = 'block';
            }
        });
    }
    
    // Add item functionality
    document.getElementById('add-item').addEventListener('click', function() {
        if (formIndex < maxForms) {
            const tbody = document.getElementById('items-tbody');
            const newRow = createNewItemRow(formIndex);
            tbody.appendChild(newRow);
            formIndex++;
            updateFormCount();
            updateTotals();
        }
    });
    
    // Remove item functionality
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-item') || e.target.parentElement.classList.contains('remove-item')) {
            const row = e.target.closest('tr');
            const deleteCheckbox = row.querySelector('input[type="checkbox"][name*="DELETE"]');
            if (deleteCheckbox) {
                deleteCheckbox.checked = true;
                row.style.display = 'none';
            } else {
                row.remove();
            }
            updateTotals();
        }
    });
    
    // Calculate totals on input change
    document.addEventListener('input', function(e) {
        if (e.target.name && (e.target.name.includes('per_unit_cost') || e.target.name.includes('units_bought') || 
            e.target.name.includes('cgst_rate') || e.target.name.includes('sgst_rate') || e.target.name.includes('igst_rate'))) {
            updateTotals();
        }
        
        // Update balance amount when amount paid changes
        if (e.target.name === 'amount_paid') {
            updateBalanceAmount();
        }
    });
    
    // Handle payment status change
    document.addEventListener('change', function(e) {
        if (e.target.name === 'payment_status') {
            handlePaymentStatusChange();
        }
    });
    
    function handlePaymentStatusChange() {
        const paymentStatus = document.querySelector('select[name="payment_status"]').value;
        const partialPaymentRow = document.getElementById('partial-payment-row');
        const paymentFields = document.querySelectorAll('.payment-field');
        
        if (paymentStatus === 'part_payment_vendor') {
            // Show partial payment fields
            partialPaymentRow.style.display = 'block';
            // Hide other payment fields for cleaner UI
            paymentFields.forEach(field => {
                if (field.getAttribute('data-field') !== 'payment_mode') {
                    field.style.display = 'none';
                }
            });
        } else if (paymentStatus === 'unpaid_vendor') {
            // Hide partial payment fields and most payment fields
            partialPaymentRow.style.display = 'none';
            paymentFields.forEach(field => {
                field.style.display = 'none';
            });
        } else {
            // Full payment - show all payment fields, hide partial payment
            partialPaymentRow.style.display = 'none';
            paymentFields.forEach(field => {
                field.style.display = 'block';
            });
        }
    }
    
    function updateBalanceAmount() {
        const totalAmount = parseFloat(document.getElementById('grand-total').textContent) || 0;
        const amountPaid = parseFloat(document.querySelector('input[name="amount_paid"]').value) || 0;
        const balanceAmount = totalAmount - amountPaid;
        
        document.getElementById('total-amount-display').textContent = totalAmount.toFixed(2);
        document.getElementById('balance-amount-display').textContent = balanceAmount.toFixed(2);
        
        // Change color based on balance
        const balanceElement = document.getElementById('balance-amount-display');
        if (balanceAmount <= 0) {
            balanceElement.className = 'form-control bg-light text-success';
        } else {
            balanceElement.className = 'form-control bg-light text-danger';
        }
    }
    
    function createNewItemRow(index) {
        const row = document.createElement('tr');
        row.className = 'item-row';
        row.innerHTML = `
            <input type="hidden" name="form-${index}-id" value="">
            <td><input type="text" name="form-${index}-purchased_item" class="form-control" required></td>
            <td><input type="text" name="form-${index}-hsn_code" class="form-control" required></td>
            <td><input type="number" name="form-${index}-per_unit_cost" class="form-control" step="0.01" required></td>
            <td><input type="number" name="form-${index}-units_bought" class="form-control" min="1" required></td>
            <td><span class="gross-total">0.00</span></td>
            <td><input type="number" name="form-${index}-cgst_rate" class="form-control form-control-sm" step="0.01" min="0" max="100" placeholder="0"></td>
            <td><span class="cgst-amount">0.00</span></td>
            <td><input type="number" name="form-${index}-sgst_rate" class="form-control form-control-sm" step="0.01" min="0" max="100" placeholder="0"></td>
            <td><span class="sgst-amount">0.00</span></td>
            <td><input type="number" name="form-${index}-igst_rate" class="form-control form-control-sm" step="0.01" min="0" max="100" placeholder="0"></td>
            <td><span class="igst-amount">0.00</span></td>
            <td><span class="total-amount">0.00</span></td>
            <td>
                <input type="checkbox" name="form-${index}-DELETE" style="display: none;">
                <button type="button" class="btn btn-sm btn-danger remove-item"><i class="fas fa-trash"></i></button>
            </td>
        `;
        return row;
    }
    
    function updateFormCount() {
        document.querySelector('input[name="form-TOTAL_FORMS"]').value = formIndex;
    }
    
    function updateTotals() {
        let subtotal = 0;
        let totalCgst = 0;
        let totalSgst = 0;
        let totalIgst = 0;
        
        // Calculate subtotal and taxes for each row
        document.querySelectorAll('.item-row').forEach(row => {
            if (row.style.display !== 'none') {
                const unitCost = parseFloat(row.querySelector('input[name*="per_unit_cost"]')?.value || 0);
                const quantity = parseFloat(row.querySelector('input[name*="units_bought"]')?.value || 0);
                const cgstRate = parseFloat(row.querySelector('input[name*="cgst_rate"]')?.value || 0);
                const sgstRate = parseFloat(row.querySelector('input[name*="sgst_rate"]')?.value || 0);
                const igstRate = parseFloat(row.querySelector('input[name*="igst_rate"]')?.value || 0);
                
                const grossTotal = unitCost * quantity;
                const cgstAmount = grossTotal * cgstRate / 100;
                const sgstAmount = grossTotal * sgstRate / 100;
                const igstAmount = grossTotal * igstRate / 100;
                const totalWithGst = grossTotal + cgstAmount + sgstAmount + igstAmount;
                
                // Update display for this row
                row.querySelector('.gross-total').textContent = grossTotal.toFixed(2);
                row.querySelector('.cgst-amount').textContent = cgstAmount.toFixed(2);
                row.querySelector('.sgst-amount').textContent = sgstAmount.toFixed(2);
                row.querySelector('.igst-amount').textContent = igstAmount.toFixed(2);
                row.querySelector('.total-amount').textContent = totalWithGst.toFixed(2);
                
                // Add to totals
                subtotal += grossTotal;
                totalCgst += cgstAmount;
                totalSgst += sgstAmount;
                totalIgst += igstAmount;
            }
        });
        
        // Calculate grand total (subtotal + all taxes)
        const grandTotal = subtotal + totalCgst + totalSgst + totalIgst;
        document.getElementById('grand-total').textContent = grandTotal.toFixed(2);
        
        // Update balance amount if in partial payment mode
        if (document.getElementById('partial-payment-row').style.display !== 'none') {
            updateBalanceAmount();
        }
    }
    
    // Initialize totals and payment status on page load
    updateTotals();
    handlePaymentStatusChange();
});
</script>

<style>
.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    border: 1px solid rgba(0, 0, 0, 0.125);
}

.card-header {
    border-bottom: 1px solid rgba(0, 0, 0, 0.125);
}

.table th {
    background-color: #343a40;
    color: white;
    font-weight: 600;
}

.btn-primary {
    background-color: #007bff;
    border-color: #007bff;
}

.btn-primary:hover {
    background-color: #0056b3;
    border-color: #0056b3;
}

.form-control:focus {
    border-color: #80bdff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.text-danger {
    color: #dc3545 !important;
}

.bg-light {
    background-color: #f8f9fa !important;
}

.payment-field {
    transition: all 0.3s ease;
}

.total-amount {
    font-weight: bold;
    color: #28a745;
}

.gross-total {
    font-weight: bold;
    color: #007bff;
}

#items-table {
    min-width: 800px;
}

.item-row input, .item-row select {
    margin-bottom: 0;
}

.remove-item {
    padding: 0.25rem 0.5rem;
}
</style>
{% endblock %} 